#version 450

struct Agent {
    vec2 pos;
    vec2 vel;
    float angle;
};

layout(std430, set = 0, binding = 0) buffer agentsBuff {
    uint count;
    Agent agents[];
};

layout(set = 0, rgba32f, binding = 1) uniform image3D rendImg;

layout(binding = 2) uniform Cfg {
    float senseAngle;
    float turnAngle;
    float senseDist;
    float speed;
    uint frame;
    float maxPheromone;
    float evaporate;
};

layout(binding = 3) uniform slice {
    int readSlice;
    int writeSlice;
}pc;

layout(local_size_x = 256, local_size_y = 1, local_size_z = 1) in;

void main(){

    uint idx = gl_GlobalInvocationID.x;

    if (idx >= count) return;
    
    Agent a = agents[idx];

    vec4 curr = imageLoad(rendImg, ivec3(a.pos, pc.readSlice));
    imageStore(rendImg, ivec3(a.pos, pc.readSlice), vec4(curr.rgb,min(maxPheromone, 1 + curr.w)));
}